# arken/packages/node/test/README.md

Protocol-focused tests for `@arken/node` socket tRPC wrappers.

## Files
- `socketLink.spec.ts`: client transport routing, callback lifecycle, duplicate-delivery idempotency, unsubscribe/teardown-vs-late-response no-op behavior (link + proxy), timeout-vs-late-response race handling, single-terminal-settlement guards for resolve/error permutations (link + proxy paths), callback-boundary resolve-throw fallback behavior for mixed `error`/`result` envelopes, ID-collision guardrails, timeout reqId metadata checks, late response handling, malformed payload permutations, strict response-id handling (non-string/blank IDs), own-property callback matching/prototype-key safety (including inherited and `__proto__` ids), deserialize-failure propagation, immediate same-tick response handling, backend-only path rejection (missing method segment), alternate response IDs, server-push malformed-param resilience (for both `trpc` and `trpcResponse` fallback paths), malformed push-method filtering, and `onAny` support including non-response filtering + fallback/teardown edge paths.
- `socketServer.spec.ts`: server dispatch, malformed payload handling (including invalid binary-string decode paths and decoded non-string/blank-string method payloads), response-id normalization checks (trimmed IDs on success; non-string/blank IDs dropped on error paths), whitespace-trimmed valid-method dispatch behavior, prototype/constructor path traversal rejection (including surrounding-whitespace, exact `constructor`, `prototype` segment, nested-segment variants, inherited built-in prototype paths like `core.toString`, inherited array-prototype method paths like `core.list.map`, and expanded inherited typed-array prototype methods like `core.bytes.map` and `core.floats.map`), empty-segment and whitespace-segment method-path rejection (`core..ping`, `core. ping`), missing method behavior, invalid/undecodable `params` payload behavior, listener attach/detach wiring, and safe no-op behavior when sockets do not expose `on`/`off` hooks.
- `httpProvider.spec.ts`: verifies `web3/httpProvider` honors explicit constructor URLs, rejects malformed non-object JSON-RPC payloads with deterministic `-32600` invalid-request errors, preserves caller-provided JSON-RPC IDs (with fallback ID behavior when omitted), keeps caller-owned request objects immutable while applying defaults internally, degrades safely to network-only flow when Cache API globals are unavailable, ignores malformed cache hits by refetching from network, rejects hung requests once provider timeout budget is exceeded, aborts in-flight fetches on timeout when abort signaling is available, and fails closed on 403 when no alternate providers are configured (no unbounded retry recursion).
- `api.spec.ts`: verifies `getFilter` maps `id` operator variants (`equals`/`in`/`contains`) to `_id` consistently, supports scalar shorthand equality inputs at root and nested logical nodes (e.g., `{ id: 'abc' }`), maps array shorthand values (including `id`) to `$in` filters, preserves non-plain object equality values (e.g., `Date`, `ObjectId`) instead of dropping them, preserves plain-object equality filters when no operator keys are present, drops no-op empty `contains` fragments inside logical OR/AND clauses, and preserves nested logical composition (e.g., `AND` entries containing `OR` groups).
- `NOTES.md`: tracking notes for additional test coverage.
